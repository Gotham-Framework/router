// Generated by CoffeeScript 1.8.0
(function() {
  this.Router = (function() {
    function Router(request) {
      this._request = this._slashes(request);
      this._routes = [];
      this._success = false;
      this._response = {};
    }

    Router.prototype.match = function(pattern, result, constraint) {
      pattern = this._slashes(pattern);
      return this._routes.push({
        pattern: pattern,
        result: result,
        parsed: this._parsePattern(pattern),
        variables: this._fetchVariables(pattern),
        constraint: constraint
      });
    };

    Router.prototype.run = function() {
      var index, params, paramsRequest, route, success, successConstraint, variable, _i, _j, _len, _len1, _ref, _ref1, _results;
      _ref = this._routes;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        route = _ref[_i];
        if (route.parsed.test(this._request)) {
          success = true;
          params = {};
          if (route.variables != null) {
            paramsRequest = route.parsed.exec(this._request);
            _ref1 = route.variables;
            for (index = _j = 0, _len1 = _ref1.length; _j < _len1; index = ++_j) {
              variable = _ref1[index];
              params[variable] = paramsRequest[index + 1];
            }
          }
          if (route.constraint != null) {
            if (typeof route.constraint === 'function') {
              successConstraint = route.constraint(params);
              if (successConstraint === false) {
                success = false;
              }
            }
          }
          if (success === true) {
            this._success = true;
            this._response = {
              result: route.result,
              params: params
            };
            break;
          } else {
            _results.push(void 0);
          }
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    Router.prototype.passes = function() {
      return this._success;
    };

    Router.prototype.fails = function() {
      if (!this._success) {
        return true;
      }
      return false;
    };

    Router.prototype.response = function() {
      return this._response;
    };

    Router.prototype._slashes = function(str) {
      if (str) {
        if (str[str.length - 1] === '/') {
          str = str.substr(0, str.length - 1);
        }
        while (str.charAt(0) === '/') {
          str = str.substr(1);
        }
      }
      return str;
    };

    Router.prototype._parsePattern = function(pattern) {
      var variables;
      variables = /(:[a-zA-Z_]*)/g;
      pattern = pattern.replace(variables, '([a-zA-Z0-9-_]*)');
      return new RegExp('^' + pattern + '$');
    };

    Router.prototype._fetchVariables = function(pattern) {
      var index, variable, variables, _i, _len;
      variables = /(:[a-zA-Z_]*)/g;
      variables = pattern.match(variables);
      if (variables != null) {
        for (index = _i = 0, _len = variables.length; _i < _len; index = ++_i) {
          variable = variables[index];
          variables[index] = variable.replace(':', '');
        }
      }
      return variables;
    };

    return Router;

  })();

}).call(this);
